<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>faven</title>
    <!-- <link -->
    <!--   href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" -->
    <!--   rel="stylesheet" -->
    <!-- /> -->
    <script defer type="module">
      import "https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.6.0/dist/alpine-ie11.min.js";
      import Compressor from "https://cdn.skypack.dev/compressorjs";
      import JSZip from "https://cdn.skypack.dev/jszip";

      window.Compressor = Compressor;
      window.JSZip = JSZip;
    </script>
  </head>
  <body class="w-screen h-screen bg-gray-500">
    <div x-data="app()">
      <input @change="handleFileInputChange" type="file" accept="image/*" />
      <a x-bind:href="href" download="faven.zip"> Download </a>
    </div>

    <script>
      const targets = [
        { size: 57, name: "apple-icon-57x57.png" },
        { size: 60, name: "apple-icon-60x60.png" },
        { size: 72, name: "apple-icon-72x72.png" },
        { size: 76, name: "apple-icon-76x76.png" },
        {
          size: 114,
          name: "apple-icon-114x114.png",
        },
        {
          size: 120,
          name: "apple-icon-120x120.png",
        },
        {
          size: 144,
          name: "apple-icon-144x144.png",
        },
        {
          size: 152,
          name: "apple-icon-152x152.png",
        },
        {
          size: 180,
          name: "apple-icon-180x180.png",
        },
        { size: 192, name: "android-icon-192x192.png" },
        { size: 32, name: "favicon-32x32.png" },
        { size: 96, name: "favicon-96x96.png" },
        { size: 16, name: "favicon-16x16.png" },
        { size: 144, name: "ms-icon-144x144.png" },
      ];

      async function compressImage(file, { width, height, name }) {
        return new Promise(
          (resolve, reject) =>
            new Compressor(file, {
              width,
              height,
              success(result) {
                resolve(
                  new File([result], name, {
                    type: result.type,
                  })
                );
              },
              error(err) {
                reject(err);
              },
            })
        );
      }

      async function zipFiles(files) {
        const zip = new JSZip();

        files.forEach((file) => {
          zip.file(file.name, file);
        });

        const outzip = await zip
          .generateAsync({ type: "blob" })
          .then(URL.createObjectURL);

        return outzip;
      }

      function app() {
        return {
          href: "",

          async handleFileInputChange(e) {
            const file = e.target.files[0];

            if (!file) {
              return;
            }

            const promises = [];
            targets.forEach(function (target) {
              promises.push(
                compressImage(file, {
                  width: target.size,
                  height: target.size,
                  name: target.name,
                })
              );
            });

            const images = await Promise.all(promises);
            this.href = await zipFiles(images);
          },
        };
      }
    </script>
  </body>
</html>
